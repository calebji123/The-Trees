<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CO2 Emissions by Country</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        color: white;
        overflow: hidden;
      }
      
      h1 {
        margin-bottom: 5px;
        font-weight: 300;
      }
      
      .subtitle {
        color: #88a;
        margin-bottom: 15px;
        font-size: 14px;
      }
      
      #bubble-container {
        position: relative;
        width: 1000px;
        height: 550px;
        background: rgba(255,255,255,0.02);
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.1);
        overflow: hidden;
      }
      
      #world-map {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0.15;
      }
      
      .country-path {
        fill: #4a5568;
        stroke: #2d3748;
        stroke-width: 0.5px;
      }
      
      .bubble {
        position: absolute;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s;
        text-align: center;
        border: 3px solid rgba(255,255,255,0.3);
        z-index: 10;
      }
      
      .bubble:hover {
        transform: scale(1.15);
        box-shadow: 0 0 30px rgba(255,255,255,0.3);
        z-index: 100;
      }
      
      .bubble.selected {
        transform: scale(1.2);
        box-shadow: 0 0 40px rgba(255,255,255,0.5);
        z-index: 101;
      }
      
      .bubble-name {
        font-weight: bold;
        font-size: 11px;
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      }
      
      .bubble-co2 {
        font-size: 9px;
        opacity: 0.9;
      }
      
      .bubble-trend {
        font-size: 12px;
        margin-top: 1px;
      }
      
      .trend-up { color: #ff6b6b; }
      .trend-down { color: #51cf66; }
      
      #chart-popup {
        position: absolute;
        background: rgba(10, 22, 40, 0.95);
        border: 2px solid #4dabf7;
        border-radius: 12px;
        padding: 15px;
        display: none;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        z-index: 200;
        min-width: 320px;
      }
      
      #chart-popup.visible {
        display: block;
      }
      
      #chart-popup h4 {
        color: #4dabf7;
        margin-bottom: 5px;
        font-size: 16px;
      }
      
      #chart-popup .stats {
        font-size: 12px;
        color: #88a;
        margin-bottom: 10px;
      }
      
      #chart-popup .stats span {
        color: #ffd43b;
        font-weight: bold;
      }
      
      .close-btn {
        position: absolute;
        top: 8px;
        right: 10px;
        background: none;
        border: none;
        color: #88a;
        font-size: 20px;
        cursor: pointer;
        line-height: 1;
      }
      
      .close-btn:hover {
        color: #fff;
      }
      
      .axis text {
        fill: #88a;
        font-size: 10px;
      }
      
      .axis line, .axis path {
        stroke: #334;
      }
      
      .grid line {
        stroke: #223;
        stroke-opacity: 0.5;
      }
      
      .legend {
        position: absolute;
        bottom: 15px;
        right: 15px;
        background: rgba(0,0,0,0.6);
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 11px;
        z-index: 50;
      }
      
      .legend-title {
        font-weight: bold;
        margin-bottom: 5px;
        color: #4dabf7;
      }
      
      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 3px 0;
      }
      
      .legend-circle {
        border-radius: 50%;
        border: 2px solid rgba(255,255,255,0.3);
      }
    </style>
  </head>
  <body>
    <h1>üåç CO2 Emissions by Country</h1>
    <p class="subtitle">Bubble size = CO2 per capita. Positioned by geography. Click to see trend.</p>
    
    <div id="bubble-container">
      <svg id="world-map"></svg>
      
      <div class="legend">
        <div class="legend-title">CO2 per Capita (tons)</div>
        <div class="legend-item">
          <div class="legend-circle" style="width: 18px; height: 18px; background: #ff6b6b;"></div>
          <span>High (>12 tons)</span>
        </div>
        <div class="legend-item">
          <div class="legend-circle" style="width: 14px; height: 14px; background: #ffd43b;"></div>
          <span>Medium (5-12 tons)</span>
        </div>
        <div class="legend-item">
          <div class="legend-circle" style="width: 10px; height: 10px; background: #51cf66;"></div>
          <span>Low (<5 tons)</span>
        </div>
        <div class="legend-item" style="margin-top: 8px;">
          <span class="trend-up">‚ñ≤</span> Rising
          <span class="trend-down" style="margin-left: 10px;">‚ñº</span> Falling
        </div>
      </div>
      
      <div id="chart-popup">
        <button class="close-btn" onclick="closePopup()">&times;</button>
        <h4 id="popup-title">Country Name</h4>
        <div class="stats" id="popup-stats"></div>
        <div id="chart"></div>
      </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <script>
      const containerWidth = 1000;
      const containerHeight = 550;
      
      // CO2 data by country with geographic coordinates
      const countries = [
        {
          name: "USA",
          lat: 39.8,
          lon: -98.5,
          color: "#e64980",
          timeSeries: [
            { year: 2000, co2: 20.2 },
            { year: 2005, co2: 19.5 },
            { year: 2010, co2: 17.4 },
            { year: 2015, co2: 16.1 },
            { year: 2020, co2: 14.2 },
            { year: 2024, co2: 13.8 }
          ]
        },
        {
          name: "China",
          lat: 35.0,
          lon: 105.0,
          color: "#4dabf7",
          timeSeries: [
            { year: 2000, co2: 2.7 },
            { year: 2005, co2: 4.5 },
            { year: 2010, co2: 6.6 },
            { year: 2015, co2: 7.5 },
            { year: 2020, co2: 7.9 },
            { year: 2024, co2: 8.4 }
          ]
        },
        {
          name: "India",
          lat: 22.0,
          lon: 78.0,
          color: "#ff922b",
          timeSeries: [
            { year: 2000, co2: 1.0 },
            { year: 2005, co2: 1.2 },
            { year: 2010, co2: 1.5 },
            { year: 2015, co2: 1.8 },
            { year: 2020, co2: 1.9 },
            { year: 2024, co2: 2.1 }
          ]
        },
        {
          name: "Germany",
          lat: 51.0,
          lon: 10.0,
          color: "#51cf66",
          timeSeries: [
            { year: 2000, co2: 10.5 },
            { year: 2005, co2: 10.0 },
            { year: 2010, co2: 9.5 },
            { year: 2015, co2: 9.1 },
            { year: 2020, co2: 7.7 },
            { year: 2024, co2: 7.2 }
          ]
        },
        {
          name: "Brazil",
          lat: -10.0,
          lon: -55.0,
          color: "#f06595",
          timeSeries: [
            { year: 2000, co2: 1.9 },
            { year: 2005, co2: 2.0 },
            { year: 2010, co2: 2.2 },
            { year: 2015, co2: 2.5 },
            { year: 2020, co2: 2.3 },
            { year: 2024, co2: 2.4 }
          ]
        },
        {
          name: "Australia",
          lat: -25.0,
          lon: 135.0,
          color: "#ffd43b",
          timeSeries: [
            { year: 2000, co2: 17.8 },
            { year: 2005, co2: 18.5 },
            { year: 2010, co2: 17.0 },
            { year: 2015, co2: 16.5 },
            { year: 2020, co2: 15.2 },
            { year: 2024, co2: 14.8 }
          ]
        },
        {
          name: "Canada",
          lat: 56.0,
          lon: -106.0,
          color: "#ff6b6b",
          timeSeries: [
            { year: 2000, co2: 17.4 },
            { year: 2005, co2: 17.0 },
            { year: 2010, co2: 15.7 },
            { year: 2015, co2: 15.5 },
            { year: 2020, co2: 14.3 },
            { year: 2024, co2: 14.0 }
          ]
        },
        {
          name: "Japan",
          lat: 36.0,
          lon: 138.0,
          color: "#be4bdb",
          timeSeries: [
            { year: 2000, co2: 9.6 },
            { year: 2005, co2: 9.8 },
            { year: 2010, co2: 9.2 },
            { year: 2015, co2: 9.5 },
            { year: 2020, co2: 8.4 },
            { year: 2024, co2: 8.1 }
          ]
        },
        {
          name: "UK",
          lat: 54.0,
          lon: -2.0,
          color: "#20c997",
          timeSeries: [
            { year: 2000, co2: 9.2 },
            { year: 2005, co2: 8.9 },
            { year: 2010, co2: 7.9 },
            { year: 2015, co2: 6.5 },
            { year: 2020, co2: 5.2 },
            { year: 2024, co2: 4.8 }
          ]
        },
        {
          name: "Mexico",
          lat: 23.0,
          lon: -102.0,
          color: "#fab005",
          timeSeries: [
            { year: 2000, co2: 3.8 },
            { year: 2005, co2: 4.1 },
            { year: 2010, co2: 3.9 },
            { year: 2015, co2: 3.8 },
            { year: 2020, co2: 3.5 },
            { year: 2024, co2: 3.6 }
          ]
        },
        {
          name: "Russia",
          lat: 60.0,
          lon: 100.0,
          color: "#748ffc",
          timeSeries: [
            { year: 2000, co2: 10.6 },
            { year: 2005, co2: 11.0 },
            { year: 2010, co2: 11.8 },
            { year: 2015, co2: 11.5 },
            { year: 2020, co2: 11.2 },
            { year: 2024, co2: 11.8 }
          ]
        },
        {
          name: "S. Korea",
          lat: 36.5,
          lon: 128.0,
          color: "#da77f2",
          timeSeries: [
            { year: 2000, co2: 9.5 },
            { year: 2005, co2: 10.0 },
            { year: 2010, co2: 11.5 },
            { year: 2015, co2: 11.8 },
            { year: 2020, co2: 11.5 },
            { year: 2024, co2: 11.2 }
          ]
        },
        {
          name: "Indonesia",
          lat: -2.0,
          lon: 118.0,
          color: "#69db7c",
          timeSeries: [
            { year: 2000, co2: 1.2 },
            { year: 2005, co2: 1.5 },
            { year: 2010, co2: 1.8 },
            { year: 2015, co2: 2.0 },
            { year: 2020, co2: 2.1 },
            { year: 2024, co2: 2.3 }
          ]
        },
        {
          name: "S. Africa",
          lat: -29.0,
          lon: 25.0,
          color: "#ffa94d",
          timeSeries: [
            { year: 2000, co2: 7.8 },
            { year: 2005, co2: 8.5 },
            { year: 2010, co2: 8.9 },
            { year: 2015, co2: 8.2 },
            { year: 2020, co2: 7.5 },
            { year: 2024, co2: 7.1 }
          ]
        },
        {
          name: "France",
          lat: 46.0,
          lon: 2.0,
          color: "#74c0fc",
          timeSeries: [
            { year: 2000, co2: 6.2 },
            { year: 2005, co2: 6.0 },
            { year: 2010, co2: 5.6 },
            { year: 2015, co2: 5.0 },
            { year: 2020, co2: 4.3 },
            { year: 2024, co2: 4.1 }
          ]
        },
        {
          name: "Saudi",
          lat: 24.0,
          lon: 45.0,
          color: "#ff8787",
          timeSeries: [
            { year: 2000, co2: 13.5 },
            { year: 2005, co2: 15.0 },
            { year: 2010, co2: 17.5 },
            { year: 2015, co2: 18.0 },
            { year: 2020, co2: 16.5 },
            { year: 2024, co2: 15.8 }
          ]
        }
      ];

      // Map projection for positioning
      const projection = d3.geoNaturalEarth1()
        .scale(170)
        .translate([containerWidth / 2, containerHeight / 2 + 20]);

      // Calculate derived properties and positions
      countries.forEach(c => {
        const latest = c.timeSeries[c.timeSeries.length - 1];
        const prev = c.timeSeries[c.timeSeries.length - 2];
        c.co2 = latest.co2;
        c.trend = latest.co2 > prev.co2 ? 'up' : 'down';
        
        // Convert lat/lon to x/y
        const pos = projection([c.lon, c.lat]);
        c.x = pos[0];
        c.y = pos[1];
      });

      // Sort by CO2 and assign ranks
      const sorted = [...countries].sort((a, b) => b.co2 - a.co2);
      sorted.forEach((c, i) => {
        const original = countries.find(o => o.name === c.name);
        original.rank = i + 1;
      });

      const container = document.getElementById('bubble-container');
      let selectedCountry = null;
      let bubbleElements = [];

      // Load and draw world map
      d3.json("https://unpkg.com/world-atlas@2/countries-110m.json")
        .then(world => {
          const countriesGeo = topojson.feature(world, world.objects.countries);
          
          const svg = d3.select("#world-map")
            .attr("width", containerWidth)
            .attr("height", containerHeight);
          
          const path = d3.geoPath().projection(projection);
          
          svg.selectAll(".country-path")
            .data(countriesGeo.features)
            .enter()
            .append("path")
            .attr("class", "country-path")
            .attr("d", path);
          
          // Create bubbles after map loads
          createBubbles();
        })
        .catch(() => {
          // Create bubbles even if map fails
          createBubbles();
        });

      // Create bubbles
      function createBubbles() {
        countries.forEach((country, i) => {
          const bubble = document.createElement('div');
          bubble.className = 'bubble';
          
          // Size based on CO2 (scaled)
          const size = Math.max(45, Math.min(100, country.co2 * 5));
          bubble.style.width = size + 'px';
          bubble.style.height = size + 'px';
          bubble.style.background = country.color;
          
          // Position based on geography (centered on bubble)
          bubble.style.left = (country.x - size/2) + 'px';
          bubble.style.top = (country.y - size/2) + 'px';
          
          // Content
          bubble.innerHTML = `
            <div class="bubble-name">${country.name}</div>
            <div class="bubble-co2">${country.co2}t</div>
            <div class="bubble-trend ${country.trend === 'up' ? 'trend-up' : 'trend-down'}">
              ${country.trend === 'up' ? '‚ñ≤' : '‚ñº'}
            </div>
          `;
          
          // Click handler
          bubble.addEventListener('click', (e) => {
            e.stopPropagation();
            selectCountry(country, bubble);
          });
          
          container.appendChild(bubble);
          
          bubbleElements.push({
            element: bubble,
            country: country,
            baseX: country.x - size/2,
            baseY: country.y - size/2,
            size: size,
            phase: Math.random() * Math.PI * 2
          });
        });
        
        // Start gentle floating animation
        animateBubbles();
      }

      // Gentle floating animation
      function animateBubbles() {
        const time = Date.now() * 0.001;
        
        bubbleElements.forEach(b => {
          // Small floating motion around base position
          const offsetX = Math.sin(time + b.phase) * 3;
          const offsetY = Math.cos(time * 0.8 + b.phase) * 3;
          
          b.element.style.left = (b.baseX + offsetX) + 'px';
          b.element.style.top = (b.baseY + offsetY) + 'px';
        });
        
        requestAnimationFrame(animateBubbles);
      }

      // Select a country
      function selectCountry(country, element) {
        // Deselect previous
        document.querySelectorAll('.bubble.selected').forEach(b => b.classList.remove('selected'));
        
        selectedCountry = country;
        element.classList.add('selected');
        
        // Calculate trend percentage
        const first = country.timeSeries[0];
        const latest = country.timeSeries[country.timeSeries.length - 1];
        const change = ((latest.co2 - first.co2) / first.co2 * 100).toFixed(1);
        const changeSign = change > 0 ? '+' : '';
        
        // Update popup
        document.getElementById('popup-title').textContent = country.name;
        document.getElementById('popup-stats').innerHTML = `
          CO2 per capita: <span>${country.co2} tons</span> | 
          Rank: <span>#${country.rank}</span> |
          Since 2000: <span>${changeSign}${change}%</span>
        `;
        
        // Position popup near bubble
        const popup = document.getElementById('chart-popup');
        const bubbleEl = bubbleElements.find(b => b.country === country);
        
        let popupX = country.x + bubbleEl.size/2 + 15;
        let popupY = country.y - 80;
        
        if (popupX + 320 > containerWidth) {
          popupX = country.x - bubbleEl.size/2 - 335;
        }
        if (popupY + 220 > containerHeight) {
          popupY = containerHeight - 230;
        }
        if (popupY < 10) popupY = 10;
        
        popup.style.left = popupX + 'px';
        popup.style.top = popupY + 'px';
        popup.classList.add('visible');
        
        drawChart(country);
      }

      // Close popup
      function closePopup() {
        document.getElementById('chart-popup').classList.remove('visible');
        document.querySelectorAll('.bubble.selected').forEach(b => b.classList.remove('selected'));
        selectedCountry = null;
      }

      // Draw chart
      function drawChart(country) {
        d3.select("#chart").html("");
        
        const margin = { top: 15, right: 20, bottom: 30, left: 45 };
        const chartWidth = 280 - margin.left - margin.right;
        const chartHeight = 150 - margin.top - margin.bottom;
        
        const chartSvg = d3.select("#chart")
          .append("svg")
          .attr("width", chartWidth + margin.left + margin.right)
          .attr("height", chartHeight + margin.top + margin.bottom)
          .append("g")
          .attr("transform", `translate(${margin.left}, ${margin.top})`);
        
        const timeSeries = country.timeSeries;
        
        // Scales
        const xScale = d3.scaleLinear()
          .domain([2000, 2024])
          .range([0, chartWidth]);
        
        const yExtent = d3.extent(timeSeries, d => d.co2);
        const yPadding = (yExtent[1] - yExtent[0]) * 0.2 || 1;
        
        const yScale = d3.scaleLinear()
          .domain([Math.max(0, yExtent[0] - yPadding), yExtent[1] + yPadding])
          .range([chartHeight, 0]);
        
        // Grid
        chartSvg.append("g")
          .attr("class", "grid")
          .selectAll("line")
          .data(yScale.ticks(4))
          .enter()
          .append("line")
          .attr("x1", 0)
          .attr("x2", chartWidth)
          .attr("y1", d => yScale(d))
          .attr("y2", d => yScale(d));
        
        // Axes
        chartSvg.append("g")
          .attr("class", "axis")
          .attr("transform", `translate(0, ${chartHeight})`)
          .call(d3.axisBottom(xScale).ticks(4).tickFormat(d3.format("d")));
        
        chartSvg.append("g")
          .attr("class", "axis")
          .call(d3.axisLeft(yScale).ticks(4));
        
        // Y-axis label
        chartSvg.append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", -35)
          .attr("x", -chartHeight / 2)
          .attr("fill", "#88a")
          .attr("font-size", "10px")
          .attr("text-anchor", "middle")
          .text("CO2 (tons/capita)");
        
        // Area
        const area = d3.area()
          .x(d => xScale(d.year))
          .y0(chartHeight)
          .y1(d => yScale(d.co2))
          .curve(d3.curveMonotoneX);
        
        chartSvg.append("path")
          .datum(timeSeries)
          .attr("fill", country.color)
          .attr("fill-opacity", 0.2)
          .attr("d", area);
        
        // Line
        const line = d3.line()
          .x(d => xScale(d.year))
          .y(d => yScale(d.co2))
          .curve(d3.curveMonotoneX);
        
        chartSvg.append("path")
          .datum(timeSeries)
          .attr("fill", "none")
          .attr("stroke", country.color)
          .attr("stroke-width", 2.5)
          .attr("d", line);
        
        // Dots
        chartSvg.selectAll(".dot")
          .data(timeSeries)
          .enter()
          .append("circle")
          .attr("cx", d => xScale(d.year))
          .attr("cy", d => yScale(d.co2))
          .attr("r", 4)
          .attr("fill", country.color)
          .attr("stroke", "#fff")
          .attr("stroke-width", 1);
      }

      // Click outside to close
      container.addEventListener('click', (e) => {
        if (e.target === container || e.target.tagName === 'svg' || e.target.tagName === 'path') {
          closePopup();
        }
      });
    </script>
  </body>
</html>
